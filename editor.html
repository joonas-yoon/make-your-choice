<!DOCTYPE html>  <!-- HTML5 document type -->
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>[Editor] The Game You Choose - 인생은 선택의 연속이다</title>
  <link rel="shortcut icon" href="./favicon.ico" type="image/x-icon">
  <link rel="icon" href="./favicon.ico" type="image/x-icon">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fomantic-ui@2.8.7/dist/semantic.min.css">
  <link rel="stylesheet" href="assets/font-awesome/css/all.min.css" type="text/css" />
  <link rel="stylesheet" href="editor.css" type="text/css" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- use go-debug.js when developing and go.js when deploying -->
  <script src="assets/gojs/release/go.js"></script>
  <script src="assets/gojs/extensions/Figures.js"></script>
</head>
<body>
  <div id="navbar" class="nav">
    <a href="#" class="item"><i class="fas fa-play"></i></a>
    <a href="#" class="item active"><i class="fas fa-edit"></i></a>
    <a href="#" class="item"><i class="fas fa-cog"></i></a>
  </div>
  <div class="body">
    <div id="viewer">
      <div id="readyEditor" class="content">
        <div class="ui placeholder inverted center aligned segment" style="height: 100%;">
          <p style="margin: 0">Click node/edge to edit a page/option</p>
        </div>
      </div>
      <div id="nodeEditor" class="content">
        <div class="ui container">
          <h1 class="ui inverted header">Edit : Page</h1>
          <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Integer porta, mauris vel tristique ullamcorper, lectus est lobortis eros, sit amet volutpat velit lacus eu nibh. Integer odio mi, feugiat egestas iaculis a, suscipit vel lorem. Nullam facilisis ipsum arcu, sed sodales nisi finibus at.</p>
          <p>Vestibulum viverra efficitur lectus, at commodo ante dapibus quis. Sed at nulla non nunc porttitor lobortis eu in urna. Cras hendrerit pellentesque mauris, nec tincidunt arcu. Cras nisl purus, porta sed orci non, tempor cursus tellus. Nam id massa augue. Curabitur odio eros, sagittis sit amet dignissim non, maximus et urna.</p>
          <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed nulla est, eleifend sit amet lobortis sodales, tempor et nulla.</p>
          <p>Donec fringilla diam a ipsum hendrerit tristique. Morbi porta hendrerit pellentesque. Vestibulum ante ipsum primis in faucibus orci luctus et ultrices posuere cubilia curae; Maecenas quam urna, tristique eu sodales a, ornare a nisi. Praesent quis maximus nibh. Vivamus suscipit congue mi, ut bibendum diam semper eget. Nulla condimentum mollis tristique. Aliquam non maximus ante. Nullam placerat posuere dui, vitae viverra dolor egestas et. Nam vehicula lacus tincidunt, rhoncus felis eget, accumsan ligula. Proin accumsan dolor ut commodo sollicitudin. Sed euismod purus vitae tortor luctus pulvinar.<p>
        </div>
      </div>
      <div id="edgeEditor" class="content">
        <div class="ui container">
          <h1 class="ui inverted header">Edit : Option</h1>
          <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit.</p>
          <p>Integer porta, mauris vel tristique ullamcorper, lectus est lobortis eros, sit amet volutpat velit lacus eu nibh. Integer odio mi, feugiat egestas iaculis a, suscipit vel lorem. Nullam facilisis ipsum arcu, sed sodales nisi finibus at.</p>
        </div>
      </div>
      <div id="player" class="content">
        <iframe src="index.html" style="width: 100%; height: 100vh; border: none; outline: 0; margin: 0; padding: 0;"></iframe>
      </div>
    </div>
    <div id="diagram"></div>
  </div>
</body>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
<script type="text/javascript">

var _ = go.GraphObject.make;
var viewDiagram =
  _(go.Diagram, "diagram",
    {
      "grid.visible": true,
      "undoManager.isEnabled": true,
      layout: _(go.LayeredDigraphLayout, // specify a Diagram.layout that arranges trees
                { direction: 90, layerSpacing: 25, columnSpacing: 100, setsPortSpots: false })
    });

// the definition of the grid system
viewDiagram.grid =
  _(go.Panel, "Grid",
    { gridCellSize: new go.Size(10, 10) },
    _(go.Shape, "LineH", { stroke: "rgba(128, 128, 128, .5)", strokeWidth: 0.2, interval: 2 }),
    _(go.Shape, "LineV", { stroke: "rgba(128, 128, 128, .5)", strokeWidth: 0.2, interval: 2 }),
    _(go.Shape, "LineH", { stroke: "rgba(128, 128, 128, .9)", strokeWidth: 0.4, interval: 10 }),
    _(go.Shape, "LineV", { stroke: "rgba(128, 128, 128, .9)", strokeWidth: 0.4, interval: 10 })
  );

// the template we defined earlier
viewDiagram.nodeTemplate =
  _(go.Node, "Auto",
    {
      isShadowed: true, shadowBlur: 1,
      shadowOffset: new go.Point(0, 1),
      shadowColor: "rgba(255, 255, 255, .2)",
      fromSpot: go.Spot.BottomSide,
      toSpot: go.Spot.TopSide,
      
      portId: "",
      cursor: "pointer",
      fromLinkable: true, fromLinkableSelfNode: true, fromLinkableDuplicates: true,
      toLinkable: true, toLinkableSelfNode: true, toLinkableDuplicates: true,

      click: nodeClicked
    },
    
    _(go.Shape,
      "RoundedRectangle", // string argument can name a predefined figure
      { fill: "#fafafa", stroke: null },
      new go.Binding("fill", "backgroundColor")),

    _(go.TextBlock, "Default Text",
      { margin: 12, stroke: "black", font: "normal 16px sans-serif", textAlign: "center", verticalAlignment: go.Spot.Center },
      new go.Binding("text", "name"),
      new go.Binding("stroke", "textColor"))
  );

viewDiagram.linkTemplate =
  _(go.Link,
    // default routing is go.Link.Normal
    // default corner is 0
    {
      routing: go.Link.AvoidsNodes,
      corner: 10,
      adjusting: go.Link.Stretch,
      reshapable: true,
      relinkableFrom: true,
      relinkableTo: true,

      click: edgeClicked
    },

    // the link path, a Shape
    _(go.Shape, { stroke: "#ffffff" }),

    // if we wanted an arrowhead we would also add another Shape with toArrow defined:
    _(go.Shape, { toArrow: "Standard", stroke: "#ffffff" }),
    
    _(go.TextBlock, { segmentOffset: new go.Point(0, -10), segmentOrientation: go.Link.OrientUpright, margin: 3, stroke: "rgba(255, 255, 255, .5)" },
      new go.Binding("text", "text"))
  );

viewDiagram.toolManager.linkingTool.temporaryLink =
  _(go.Link,
    { layerName: "Tool" },
    _(go.Shape,
      { stroke: "gray", strokeWidth: 2, strokeDashArray: [4, 2] })
  );

var tempFromNode =
  _(go.Node,
    { layerName: "Tool" },
    _(go.Shape, "RoundedRectangle",
      { stroke: "#ff3333", strokeWidth: 3, fill: null,
        portId: "", width: 1, height: 1 })
  );
viewDiagram.toolManager.linkingTool.temporaryFromNode = tempFromNode;
viewDiagram.toolManager.linkingTool.temporaryFromPort = tempFromNode.port;

var tempToNode =
  _(go.Node,
    { layerName: "Tool" },
    _(go.Shape, "RoundedRectangle",
      { stroke: "#ffff33", strokeWidth: 3, fill: null,
        portId: "", width: 1, height: 1 })
  );
viewDiagram.toolManager.linkingTool.temporaryToNode = tempToNode;
viewDiagram.toolManager.linkingTool.temporaryToPort = tempToNode.port;

var sampleModel = _(go.GraphLinksModel);
sampleModel.nodeDataArray =
[
  { key: "1", name: "Loading...", backgroundColor: null, textColor: "white" }
];
viewDiagram.model = sampleModel;

$.ajax({
  url: './1.json',
  cache: true,
  dataType: 'json',
  async: false,
  success: function(data) {
    var newDigModel = _(go.GraphLinksModel);
    var stories = data.stories || {};
    var ids = Object.keys(stories) || [];
    var nodes = [];
    var links = [];
    for(var i = 0; i < ids.length; ++i) {
      var node = { key: ids[i], name: '#' + ids[i] };
      if (data.start == ids[i]) {
        node.backgroundColor = '#1e90ff';
        node.textColor = '#ffffff';
      }
      nodes.push(node);
    }
    for(var i = 0; i < ids.length; ++i) {
      var page = stories[ids[i]];
      if (page.choice) {
        var choices = Object.keys(page.choice) || [];
        for(var j = 0; j < choices.length; ++j) {
          links.push({ from: ids[i], to: page.choice[choices[j]].next, text: page.choice[choices[j]].title });
        }
      } else {
        links.push({ from: ids[i], to: page.next, text: null });
      }
    }
    newDigModel.nodeDataArray = nodes;
    newDigModel.linkDataArray = links;
    viewDiagram.model = newDigModel;
    
    getCurrentView('readyEditor');
  },
  // complete: console.log,
  error: function(req, status, error) {
    var newDigModel = _(go.GraphLinksModel);
    newDigModel.nodeDataArray = [{ key: 0, name: req.statusText.split(': ').join(':\n'), textColor: 'red', backgroundColor: null }];
    viewDiagram.model = newDigModel;
  }
});

function nodeClicked(e, obj) {
  getCurrentView('nodeEditor');
  var node = obj.part;
  console.log(node);
}

function edgeClicked(e, obj) {
  getCurrentView('edgeEditor');
  var edge = obj.part;
  console.log(edge);
}

function getCurrentView(id) {
  var viewer = document.getElementById('viewer');
  var contents = viewer.getElementsByClassName('content');
  // hide all contents and show matched
  for (var i = 0; i < contents.length; ++i) {
    if (contents[i].id == id) {
      contents[i].classList.add('active');
    } else {
      contents[i].classList.remove('active');
    }
  }
}

</script>
<script src="https://cdn.jsdelivr.net/npm/fomantic-ui@2.8.7/dist/semantic.min.js"></script>
</html>