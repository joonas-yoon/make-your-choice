<!DOCTYPE html>  <!-- HTML5 document type -->
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>[Editor] The Game You Choose - 인생은 선택의 연속이다</title>
  <link rel="shortcut icon" href="./favicon.ico" type="image/x-icon">
  <link rel="icon" href="./favicon.ico" type="image/x-icon">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fomantic-ui@2.8.7/dist/semantic.min.css">
  <link rel="stylesheet" href="assets/font-awesome/css/all.min.css" type="text/css" />
  <link rel="stylesheet" href="editor.css" type="text/css" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- use go-debug.js when developing and go.js when deploying -->
  <script src="assets/gojs/release/go.js"></script>
  <script src="assets/gojs/extensions/Figures.js"></script>
</head>
<body>
  <div id="navbar" class="nav">
    <a href="#" class="item"><i class="fas fa-play"></i></a>
    <a href="#" class="item active"><i class="fas fa-edit"></i></a>
    <a href="#" class="item"><i class="fas fa-cog"></i></a>
  </div>
  <div class="body">
    <div id="viewer">
      <div id="readyEditor" class="content">
        <div class="ui placeholder inverted center aligned segment" style="height: 100%;">
          <p style="margin: 0">Click node/edge to edit a page/option</p>
        </div>
      </div>
      <div id="nodeEditor" class="content">
        <div class="ui container">
          <h1 class="ui inverted header">Edit : Page (<span id="pageName"></span>)</h1>
          <div class="ui inverted form">
            <div class="required field">
              <label>Description</label>
              <textarea class="editor" placeholder="Edit description here ..."></textarea>
            </div>
            <!-- checkbox for ending -->
            <div class="inline field">
              <div id="propEnd" class="ui inverted toggle red checkbox">
                <input type="checkbox" tabindex="0" class="hidden">
                <label>This is <b>the end</b></label>
              </div>
            </div>
            <div class="field">
              <button id="saveButton" class="ui primary button" type="button">Save</button>
              <button id="deleteButton" class="ui inverted red button" type="button">Delete</button>
            </div>
          </div>
        </div>
      </div>
      <div id="edgeEditor" class="content">
        <div class="ui container">
          <h1 class="ui inverted header" style="margin-bottom: .2rem">Edit : Option</h1>
          <h2 style="font-size: 1.3rem; margin-top: 0;">(<span id="pageFrom"></span> &#8594; <span id="pageTo"></span>)</h2>
          <div class="ui inverted form" style="margin-bottom: 1rem;">
            <div class="inline field">
              <div id="propDirect" class="ui inverted toggle blue checkbox">
                <input type="checkbox" tabindex="0" class="hidden">
                <label>No option</label>
              </div>
            </div>
          </div>
          <div class="ui inverted toggle form">
            <div class="required field">
              <label>Option Text</label>
              <input type="text" name="otext" placeholder="Option text here ..." value=""/>
            </div>
            <!-- conditions -->
            <div class="field" id="edgeConditions">
              <label>Conditions</label>
              <button class="ui basic fluid inverted add button">
                <i class="plus icon"></i> Add condition
              </button>
            </div>
            <!-- updates -->
            <div class="field" id="edgeUpdates">
              <label>Updates</label>
              <button class="ui basic fluid inverted add button">
                <i class="plus icon"></i> Add updates
              </button>
            </div>
          </div>
          <div class="ui inverted form" style="margin-bottom: 1rem;">
            <div class="field" style="margin-top: 2rem;">
              <button id="saveButton" class="ui primary button" type="button">Save</button>
              <button id="deleteButton" class="ui inverted red button" type="button">Delete</button>
            </div>
          </div>
        </div>
      </div>
      <div id="player" class="content">
        <iframe src="index.html" style="width: 100%; height: 100vh; border: none; outline: 0; margin: 0; padding: 0;"></iframe>
      </div>
    </div>
    <div id="diagram"></div>
  </div>
</body>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/fomantic-ui@2.8.7/dist/semantic.min.js"></script>
<script type="text/javascript">

var _ = go.GraphObject.make;
var viewDiagram =
  _(go.Diagram, "diagram",
    {
      "grid.visible": true,
      "undoManager.isEnabled": true,
      layout: _(go.LayeredDigraphLayout, // specify a Diagram.layout that arranges trees
                { direction: 90, layerSpacing: 25, columnSpacing: 100, setsPortSpots: false })
    });

// the definition of the grid system
viewDiagram.grid =
  _(go.Panel, "Grid",
    { gridCellSize: new go.Size(10, 10) },
    _(go.Shape, "LineH", { stroke: "rgba(128, 128, 128, .5)", strokeWidth: 0.2, interval: 2 }),
    _(go.Shape, "LineV", { stroke: "rgba(128, 128, 128, .5)", strokeWidth: 0.2, interval: 2 }),
    _(go.Shape, "LineH", { stroke: "rgba(128, 128, 128, .9)", strokeWidth: 0.4, interval: 10 }),
    _(go.Shape, "LineV", { stroke: "rgba(128, 128, 128, .9)", strokeWidth: 0.4, interval: 10 })
  );

// the template we defined earlier
viewDiagram.nodeTemplate =
  _(go.Node, "Auto",
    {
      isShadowed: true, shadowBlur: 1,
      shadowOffset: new go.Point(0, 1),
      shadowColor: "rgba(255, 255, 255, .2)",
      fromSpot: go.Spot.BottomSide,
      toSpot: go.Spot.TopSide,
      
      portId: "",
      cursor: "pointer",
      fromLinkable: true, fromLinkableSelfNode: true, fromLinkableDuplicates: true,
      toLinkable: true, toLinkableSelfNode: true, toLinkableDuplicates: true,

      click: nodeClicked
    },
    
    _(go.Shape,
      "RoundedRectangle", // string argument can name a predefined figure
      { fill: "#fafafa", stroke: null },
      new go.Binding("fill", "backgroundColor")),

    _(go.TextBlock, "Default Text",
      { margin: 12, stroke: "black", font: "normal 16px sans-serif", textAlign: "center", verticalAlignment: go.Spot.Center },
      new go.Binding("text", "name"),
      new go.Binding("stroke", "textColor"))
  );

viewDiagram.linkTemplate =
  _(go.Link,
    // default routing is go.Link.Normal
    // default corner is 0
    {
      routing: go.Link.AvoidsNodes,
      corner: 10,
      adjusting: go.Link.Stretch,
      reshapable: true,
      relinkableFrom: true,
      relinkableTo: true,

      click: edgeClicked
    },

    // the link path, a Shape
    _(go.Shape, { stroke: "#ffffff" }),

    // if we wanted an arrowhead we would also add another Shape with toArrow defined:
    _(go.Shape, { toArrow: "Standard", stroke: "#ffffff" }),
    
    _(go.TextBlock, { segmentOffset: new go.Point(0, -10), segmentOrientation: go.Link.OrientUpright, margin: 3, stroke: "rgba(255, 255, 255, .5)" },
      new go.Binding("text", "text"))
  );

viewDiagram.toolManager.linkingTool.temporaryLink =
  _(go.Link,
    { layerName: "Tool" },
    _(go.Shape,
      { stroke: "gray", strokeWidth: 2, strokeDashArray: [4, 2] })
  );

var tempFromNode =
  _(go.Node,
    { layerName: "Tool" },
    _(go.Shape, "RoundedRectangle",
      { stroke: "#ff3333", strokeWidth: 3, fill: null,
        portId: "", width: 1, height: 1 })
  );
viewDiagram.toolManager.linkingTool.temporaryFromNode = tempFromNode;
viewDiagram.toolManager.linkingTool.temporaryFromPort = tempFromNode.port;

var tempToNode =
  _(go.Node,
    { layerName: "Tool" },
    _(go.Shape, "RoundedRectangle",
      { stroke: "#ffff33", strokeWidth: 3, fill: null,
        portId: "", width: 1, height: 1 })
  );
viewDiagram.toolManager.linkingTool.temporaryToNode = tempToNode;
viewDiagram.toolManager.linkingTool.temporaryToPort = tempToNode.port;

var sampleModel = _(go.GraphLinksModel);
sampleModel.nodeDataArray =
[
  { key: "1", name: "Loading...", backgroundColor: null, textColor: "white" }
];
viewDiagram.model = sampleModel;

var gameJson = {};

$.ajax({
  url: './1.json',
  cache: true,
  dataType: 'json',
  async: false,
  success: function(json){
    gameJson = json;
    drawDiagram(json);
    getCurrentView('readyEditor');
  },
  // complete: console.log,
  error: function(req, status, error) {
    var newDigModel = _(go.GraphLinksModel);
    newDigModel.nodeDataArray = [{ key: 0, name: req.statusText.split(': ').join(':\n'), textColor: 'red', backgroundColor: null }];
    viewDiagram.model = newDigModel;
  }
});

function drawDiagram(json) {
  var newDigModel = _(go.GraphLinksModel);
  var stories = json.stories || {};
  var ids = Object.keys(stories) || [];
  var nodes = [];
  var links = [];
  for(var i = 0; i < ids.length; ++i) {
    var node = { key: ids[i], name: '#' + ids[i] };
    if (json.start == ids[i]) {
      node.backgroundColor = '#1e90ff';
      node.textColor = '#ffffff';
    }
    nodes.push(node);
  }
  for(var i = 0; i < ids.length; ++i) {
    var page = stories[ids[i]];
    if (page.choice) {
      var choices = Object.keys(page.choice) || [];
      for(var j = 0; j < choices.length; ++j) {
        var f = ids[i], t = page.choice[choices[j]].next;
        links.push({ key: f+'-'+t+'-'+j, from: f, to: t, text: page.choice[choices[j]].title });
      }
    } else {
      var f = ids[i], t = page.next;
      links.push({ key: f+'-'+t, from: f, to: t, text: null });
    }
  }
  newDigModel.nodeDataArray = nodes;
  newDigModel.linkDataArray = links;
  viewDiagram.model = newDigModel;
}

function nodeClicked(e, obj) {
  getCurrentView('nodeEditor');
  var node = obj.part;
  var data = gameJson.stories[node.data.key];
  var editForm = document.getElementById('nodeEditor');
  editForm.querySelector('#pageName').innerText = node.data.name;
  $(editForm.querySelector('#propEnd')).checkbox(data.end ? 'check' : 'uncheck');
  var editor = editForm.querySelector('textarea.editor');
  editor.value = data.sentences.join('\n\n') || '';
  resizeTextarea(editor);
  var saveButton = document.getElementById('saveButton');
  var btn = saveButton.cloneNode(true);
  btn.addEventListener('click', function(evt){
    evt.preventDefault();
    var s = gameJson.stories, k = node.data.key;
    s[k].sentences = (editor.value || '').trim().replace(/\n+/g, '\n').split('\n');
    drawDiagram(gameJson);
    $('body').toast({
      class: 'success',
      title: 'Page ' + node.data.name,
      message: 'Your page has been saved successfully'
    });
    return false;
  });
  saveButton.parentNode.replaceChild(btn, saveButton);
}

function edgeClicked(e, obj) {
  getCurrentView('edgeEditor');
  var edge = obj.part;
  var editForm = document.getElementById('edgeEditor');
  var from = edge.data.from, to = edge.data.to;
  var dataFrom = gameJson.stories[from];
  var dataTo = gameJson.stories[to];
  editForm.querySelector('#pageFrom').innerText = '#' + from;
  editForm.querySelector('#pageTo').innerText = '#' + to;
  editForm.querySelector('input[name=otext]').value = edge.data.text || '';
  var chkbox = editForm.querySelector('#propDirect');
  $(chkbox).checkbox({
    onChecked: function(){
      $(editForm.querySelector('.toggle.form')).transition('fade up');
    },
    onUnchecked: function(){
      $(editForm.querySelector('.toggle.form')).transition('fade down');
    }
  }).checkbox(edge.data.key.split('-').length == 2 ? 'check' : 'uncheck');
  
  console.log(edge.data);
}

function getCurrentView(id) {
  var viewer = document.getElementById('viewer');
  var contents = viewer.getElementsByClassName('content');
  // hide all contents and show matched
  for (var i = 0; i < contents.length; ++i) {
    if (contents[i].id == id) {
      contents[i].classList.add('active');
    } else {
      contents[i].classList.remove('active');
    }
  }
}

function resizeTextarea(el) {
  $(el).height(1).height($(el).prop('scrollHeight'));
}

$('.ui.checkbox').checkbox();
$('textarea').on('keydown keyup keypress', function() {
  resizeTextarea(this);
});
</script>
</html>